from dash import html, dcc, Input, Output, State, no_update
import dash_bootstrap_components as dbc
from datetime import datetime

ProbePanel = dbc.Card(
    dbc.CardBody([
        html.H5("Probes (auto-discovery)"),
        dbc.Row([
            dbc.Col([
                html.Button("Scan now", id="probe-scan", className="btn btn-secondary btn-sm"),
                dcc.Interval(id="probe-refresh", interval=5000, n_intervals=0),
                html.Div(id="probe-scan-status", className="text-info mt-2")
            ], width=4),
            dbc.Col([
                dbc.Label("Auto-provision new probes"),
                dcc.Checklist(id="auto-provision", options=[{"label": " Enabled", "value": "on"}], value=["on"], persistence=True),
                dbc.Label("Push interval (ms)", className="mt-2"),
                dcc.Input(id="push-interval-ms", type="number", min=500, step=100, value=5000, persistence=True),
                dbc.Label("Provision token (optional)", className="mt-2"),
                dcc.Input(id="provision-token", type="text", placeholder="X-Token to send to hub", persistence=True),
                html.Button("Save Provision Settings", id="save-provision", className="btn btn-primary btn-sm mt-2"),
                html.Div(id="provision-save-status", className="text-info mt-2")
            ], width=8)
        ], className="gy-2"),
        html.Hr(),
        html.Div(id="probe-list")
    ])
)


def _render_probes(items):
    if not items:
        return html.Small("(no probes found yet)", className="text-muted")
    cards = []
    for p in items:
        pid = p.get("probe_id") or "(unknown)"
        host = p.get("host") or "?"
        port = p.get("port") or 0
        last = p.get("last_seen")
        last_str = last if isinstance(last, str) else (last.isoformat(sep=" ") if last else "")
        cards.append(
            dbc.Card(dbc.CardBody([
                html.Div([
                    dbc.Badge(pid, color="info", className="me-2"),
                    html.Code(f"{host}:{port}")
                ]),
                html.Small(f"Last seen: {last_str}", className="text-muted d-block mt-1")
            ]), className="mb-2")
        )
    return html.Div(cards)


# discovery: object must expose list_probes() -> dict[str, obj] and scan()
# cfg_get/set handled by /api/config (already in your api routes)

def register_probe_callbacks(app, discovery, cfg):
    @app.callback(
        Output("probe-list", "children"),
        Input("probe-refresh", "n_intervals"),
        prevent_initial_call=False
    )
    def _refresh_list(_):
        try:
            entries = []
            for p in (discovery.list_probes() or {}).values():
                entries.append({
                    "probe_id": getattr(p, "probe_id", None) or getattr(p, "id", None) or getattr(p, "name", None),
                    "host": getattr(p, "host", None),
                    "port": getattr(p, "port", None),
                    "last_seen": getattr(p, "last_seen", None),
                })
            return _render_probes(entries)
        except Exception:
            return _render_probes([])

    @app.callback(
        Output("probe-scan-status", "children"),
        Input("probe-scan", "n_clicks"),
        prevent_initial_call=True
    )
    def _scan(_n):
        try:
            discovery.scan()
            return "ğŸ” Scanned"
        except Exception as e:
            return f"âŒ {e}" 

    @app.callback(
        Output("provision-save-status", "children"),
        Input("save-provision", "n_clicks"),
        State("auto-provision", "value"),
        State("push-interval-ms", "value"),
        State("provision-token", "value"),
        prevent_initial_call=True
    )
    def _save_prov(_, auto_vals, ms, token):
        try:
            auto = bool(auto_vals and "on" in auto_vals)
            # Persist via cfg (mirrors /api/config semantics you already have)
            with cfg.lock:
                cfg.data["auto_provision"] = auto
                if ms:
                    # UI keeps ms; server api/routes converts interval_sec -> pushes to probes
                    cfg.data["interval_sec"] = max(1, int(int(ms)/1000))
            cfg.save()
            return "âœ… Saved"
        except Exception as e:
            return f"âŒ {e}"
