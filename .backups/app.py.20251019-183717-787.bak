import dash
from dash import html, dcc
from dash.dependencies import Input, Output
import pandas as pd
import requests, datetime, os, time

ESP32_URL = "http://192.168.1.202/"  # Your ESP32 endpoint
CSV_FILE = "temperature_log.csv"
REFRESH_INTERVAL = 5000  # ms

# --- Ensure CSV exists ---
if not os.path.exists(CSV_FILE):
    pd.DataFrame(columns=["timestamp", "temperature_c", "temperature_f"]).to_csv(CSV_FILE, index=False)

def fetch_temp():
    """Read plain text CSV from ESP32 and parse it."""
    try:
        r = requests.get(ESP32_URL, timeout=3)
        r.raise_for_status()
        lines = r.text.strip().splitlines()

        # Expected format:
        # timestamp_ms,temperature_C,temperature_F
        # 123456,24.12,75.42
        if len(lines) < 2:
            return None

        header, data = lines[0], lines[1]
        parts = data.split(',')
        if len(parts) < 3:
            return None

        timestamp_ms = int(parts[0])
        t_c = float(parts[1])
        t_f = float(parts[2])
        ts = datetime.datetime.now().isoformat(timespec="seconds")

        return ts, t_c, t_f
    except Exception as e:
        print(f"[WARN] fetch_temp failed: {e}")
        return None

def append_csv(reading):
    ts, c, f = reading
    df = pd.DataFrame([[ts, c, f]], columns=["timestamp", "temperature_c", "temperature_f"])
    df.to_csv(CSV_FILE, mode="a", header=False, index=False)

# --- Dash App Setup ---
app = dash.Dash(__name__, title="ESP32 Temperature Monitor")
server = app.server

app.layout = html.Div([
    html.H3("ðŸŒ¡ï¸ ESP32 Temperature Monitor (CSV Mode)"),
    html.Div(id="live-temp", style={"fontSize": "1.2em", "marginBottom": "10px"}),
    dcc.Graph(id="temp-graph"),
    dcc.Interval(id="interval", interval=REFRESH_INTERVAL, n_intervals=0)
], style={"padding": "20px", "fontFamily": "Arial"})

@app.callback(
    Output("temp-graph", "figure"),
    Output("live-temp", "children"),
    Input("interval", "n_intervals")
)
def update_graph(n):
    reading = fetch_temp()
    if reading:
        append_csv(reading)

    try:
        df = pd.read_csv(CSV_FILE)
    except Exception:
        df = pd.DataFrame(columns=["timestamp", "temperature_c", "temperature_f"])

    if df.empty:
        return {"data": [], "layout": {"title": "No data yet"}}, "Waiting for sensor data..."

    fig = {
        "data": [
            {"x": df["timestamp"], "y": df["temperature_c"], "mode": "lines+markers", "name": "Temp Â°C"},
            {"x": df["timestamp"], "y": df["temperature_f"], "mode": "lines", "name": "Temp Â°F", "yaxis": "y2"}
        ],
        "layout": {
            "xaxis": {"title": "Time"},
            "yaxis": {"title": "Â°C"},
            "yaxis2": {"title": "Â°F", "overlaying": "y", "side": "right"},
            "margin": {"l": 60, "r": 60, "t": 40, "b": 40},
            "height": 500
        }
    }

    ts, c, f = reading if reading else (None, None, None)
    live = f"Last reading: {ts} â€” {c:.2f} Â°C / {f:.2f} Â°F" if reading else "No new reading yet."

    return fig, live

if __name__ == "__main__":
    host = os.getenv("HOST", "0.0.0.0")
    port = int(os.getenv("PORT", "8088"))
    print(f"[INFO] Dash server running at http://{host}:{port}")
    app.run(host=host, port=port)
