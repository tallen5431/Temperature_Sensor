import os, threading
from pathlib import Path

import pandas as pd
import dash
from dash import Dash, html, dcc
import dash_bootstrap_components as dbc

from flask import Flask
from werkzeug.middleware.dispatcher import DispatcherMiddleware

# Core modules
from core.config import Config
from core.storage import ensure_csv
from probe_discovery import ProbeDiscovery
from api.routes import create_api

# Components
from components.temp_graph import GraphSection, register_callbacks
from components.probe_panel import ProbePanel, register_probe_callbacks

# mDNS advertise (optional)
from contextlib import suppress
from zeroconf import Zeroconf, ServiceInfo
import socket

BASE_DIR = Path(__file__).resolve().parent
CSV_FILE = BASE_DIR / "temperature_log.csv"
CONFIG_FILE = BASE_DIR / "config.json"

ensure_csv(CSV_FILE)

# Load / create config
cfg = Config(CONFIG_FILE)

# Discovery service
finder = ProbeDiscovery()

# Flask hosting for API + Dash
server = Flask(__name__)
api_bp = create_api(cfg, CSV_FILE, finder, lambda: os.getenv("PUBLIC_BASE", "http://temps-hub.local:8088"), os.getenv("SERVER_TOKEN", ""))
server.register_blueprint(api_bp)

# Wrap Dash app
app = Dash(__name__, external_stylesheets=[dbc.themes.CYBORG], server=server, url_base_pathname="/")
app.title = "Temperature Monitor"

app.layout = dbc.Container([
    html.H3("ðŸŒ¡ï¸ Temperature Monitor & Ingest API"),
    dbc.Row([
        dbc.Col(dbc.Card(dbc.CardBody([
            html.H5("Logging Controls"),
            dbc.Row([
                dbc.Col([
                    dbc.Label("Pull mode enabled"),
                    dcc.Checklist(id="pull-enabled", options=[{"label": " Enabled", "value": "on"}],
                                  value=["on"] if cfg.get("pull_enabled", True) else [])
                ], width=6),
                dbc.Col([
                    dbc.Label("Interval (sec)"),
                    dcc.Input(id="interval-sec", type="number", min=1, step=1, value=int(cfg.get("interval_sec", 5)))
                ], width=6),
            ], className="gy-2"),
            html.Button("Save", id="save-config", className="btn btn-primary btn-sm mt-2"),
            html.Div(id="save-status", className="mt-2 text-info")
        ])), width=4),
        dbc.Col(GraphSection, width=8)
    ], className="mt-3"),
    dbc.Row([
        dbc.Col(ProbePanel, width=6),
        dbc.Col(dbc.Card(dbc.CardBody([
            html.H5("Latest Reading"),
            html.Div(id="latest-reading", className="display-6"),
            dcc.Interval(id="ui-refresh", interval=3000, n_intervals=0)
        ])), width=6),
    ], className="mt-3"),
    dbc.Alert([
        html.Div("Device push endpoint: POST JSON to "),
        html.Code("/api/ingest"),
        html.Span(" with keys like "),
        html.Code("{ 'timestamp': '2025-10-20T12:00:00', 'temperature_c': 24.5 }")
    ], color="dark", className="mt-4"),
    html.Div([
        html.Small("Config API: GET/POST "), html.Code("/api/config"), html.Small(" (JSON)")
    ], className="text-muted")
], fluid=True)

# ---- Callbacks wiring ----
register_callbacks(app, CSV_FILE)
register_probe_callbacks(app, finder, cfg)

# -------------------- Inline mDNS (Bonjour) advertiser --------------------
class _MdnsAdvert:
    def __init__(self):
        self.zeroconf = None
        self.info = None

    def _lan_ip(self) -> str:
        ip = "127.0.0.1"
        with suppress(Exception):
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            try:
                s.connect(("8.8.8.8", 80))
                ip = s.getsockname()[0]
            finally:
                s.close()
        return ip

    def start(self, port: int, instance_name: str = "TempSensor Hub", hostname: str = "temps-hub.local."):
        ip = self._lan_ip()
        addr = socket.inet_aton(ip)
        self.info = ServiceInfo(
            type_="_http._tcp.local.",
            name=f"{instance_name}._http._tcp.local.",
            addresses=[addr],
            port=port,
            properties={},
            server=hostname,
        )
        self.zeroconf = Zeroconf()
        self.zeroconf.register_service(self.info)
        return ip

    def stop(self):
        with suppress(Exception):
            if self.zeroconf and self.info:
                self.zeroconf.unregister_service(self.info)
        with suppress(Exception):
            if self.zeroconf:
                self.zeroconf.close()
        self.zeroconf = None
        self.info = None


if __name__ == "__main__":
    host = os.getenv("HOST", "0.0.0.0")
    port = int(os.getenv("PORT", "8088"))

    mdns = _MdnsAdvert() if (os.getenv("MDNS_ENABLE", "1") not in ("0","false","False")) else None
    try:
        if mdns:
            try:
                ip = mdns.start(port)
                print(f"[mDNS] Advertising http://temps-hub.local:{port} (ip {ip})")
            except Exception as e:
                print(f"[mDNS] advertise failed: {e}")
        app.run(host=host, port=port, debug=False)
    finally:
        if mdns:
            mdns.stop()
