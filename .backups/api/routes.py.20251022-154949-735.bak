from __future__ import annotations
from flask import Blueprint, request, jsonify
from typing import Any, Dict, List, Tuple, Callable
import os, csv, datetime

from auto_provision import provision_probe


def create_api(cfg: Any, csv_path: str, discovery: Any, public_base: Callable[[], str], server_token: str = "") -> Blueprint:
    bp = Blueprint("api", __name__, url_prefix="/api")

    TOKEN = (server_token or "").strip()

    def _check_auth() -> bool:
        if not TOKEN:
            return True
        tok = request.headers.get("X-Token") or request.args.get("token")
        if not tok and request.is_json:
            data = request.get_json(silent=True) or {}
            tok = data.get("token")
        return tok == TOKEN

    def _iter_probes() -> List[Dict[str, Any]]:
        if discovery is None:
            return []
        try:
            vals = discovery.list_probes().values()
        except Exception:
            vals = []
        out: List[Dict[str, Any]] = []
        for obj in vals:
            is_dict = isinstance(obj, dict)
            get = (lambda k, d=None: (obj.get(k, d) if is_dict else getattr(obj, k, d)))
            props = get("props", {}) or {}
            host = get("host")
            ip = get("ip")
            port = get("port", 80) or 80
            name = get("name") or get("id") or props.get("name")
            pid = props.get("id") or get("probe_id") or get("id") or name
            out.append({
                "host": host,
                "ip": ip,
                "port": port,
                "name": name,
                "probe_id": pid,
            })
        return out

    @bp.get("/health")
    def health():
        return jsonify(ok=True, probes=len(_iter_probes()), time=datetime.datetime.now().isoformat(timespec="seconds"))

    @bp.get("/config")
    def get_config():
        # Always return the underlying dict
        try:
            return jsonify(cfg.to_dict())
        except Exception:
            try:
                return jsonify(cfg.data)
            except Exception:
                return jsonify({})

    @bp.post("/config")
    def set_config():
        if not _check_auth():
            return jsonify(ok=False, error="unauthorized"), 401
        data = request.get_json(silent=True) or {}
        try:
            cfg.update(data)  # provided by core.Config
        except Exception:
            pass
        return jsonify(ok=True)

    @bp.get("/probes")
    def list_probes():
        return jsonify(_iter_probes())

    @bp.post("/provision")
    def provision():
        if not _check_auth():
            return jsonify(ok=False, error="unauthorized"), 401
        data = request.get_json(silent=True) or {}
        host = (data.get("host") or "").strip()
        port = int(data.get("port") or 80)
        interval_ms = int(data.get("interval_ms") or data.get("interval") or 5000)
        tok = (data.get("token") or TOKEN or "").strip()
        base = public_base().rstrip("/")

        targets: List[Tuple[str, int]] = []
        if host:
            targets.append((host, port))
        else:
            for p in _iter_probes():
                target = (p.get("ip") or p.get("host") or "").rstrip(".")
                if target:
                    targets.append((target, int(p.get("port") or 80)))

        ok_any = False
        succeeded: List[str] = []
        failed: List[str] = []
        for h, prt in targets:
            try:
                if provision_probe(h, prt, base, token=tok, interval_ms=interval_ms):
                    ok_any = True
                    succeeded.append(f"{h}:{prt}")
                else:
                    failed.append(f"{h}:{prt}")
            except Exception:
                failed.append(f"{h}:{prt}")
        return jsonify(ok=ok_any, provided_to=succeeded, failed=failed, server_base=base)

    @bp.post("/ingest")
    def ingest():
        if not _check_auth():
            return jsonify(ok=False, error="unauthorized"), 401
        data = request.get_json(silent=True) or {}
        try:
            t_c = float(data.get("temperature_c"))
        except Exception:
            return jsonify(ok=False, error="temperature_c required"), 400
        probe_id = request.headers.get("X-Probe-ID") or (data.get("probe_id") or "")
        _append_csv(csv_path, t_c, probe_id)
        return jsonify(ok=True)

    @bp.get("/ingest")
    def ingest_query():
        if not _check_auth():
            return jsonify(ok=False, error="unauthorized"), 401
        try:
            t_c = float(request.args.get("temperature_c") or request.args.get("t"))
        except Exception:
            return jsonify(ok=False, error="temperature_c required"), 400
        probe_id = request.args.get("probe_id") or ""
        _append_csv(csv_path, t_c, probe_id)
        return jsonify(ok=True)

    @bp.post("/ingest_csv")
    def ingest_csv():
        if not _check_auth():
            return jsonify(ok=False, error="unauthorized"), 401
        text = request.data.decode("utf-8", "ignore")
        n = 0
        for line in text.splitlines():
            parts = [p.strip() for p in line.split(",")]
            if not parts:
                continue
            try:
                t_c = float(parts[0])
            except Exception:
                continue
            pid = parts[1] if len(parts) > 1 else ""
            _append_csv(csv_path, t_c, pid)
            n += 1
        return jsonify(ok=True, rows=n)

    return bp


def _append_csv(csv_path: str, t_c: float, probe_id: str) -> None:
    exists = os.path.exists(csv_path)
    with open(csv_path, "a", newline="") as f:
        w = csv.writer(f)
        if not exists:
            w.writerow(["timestamp", "temperature_c", "temperature_f", "probe_id"])
        t_f = (t_c * 9.0 / 5.0) + 32.0
        ts = datetime.datetime.now().isoformat(timespec="seconds")
        w.writerow([ts, f"{t_c:.3f}", f"{t_f:.3f}", probe_id])
